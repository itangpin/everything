/*! Everything 2015-04-07 */
define(function(a,b,c){var d=a("./util.js"),e=function(a,b){this.value=a,this.formatValue(),this.app=b,this.childs=[],this.childrenMap={},this.isRootNode=!1,this.id=d.uuid(),this.app.packages.length>0&&this.initPackages(),this._createDom(),this.getPath(),this.highlighted=!1};e.getNodeFromTarget=function(a){for(;a;){if(a.node)return a.node;a=a.parentNode}return void 0},e.prototype._updateDomIndexes=function(){var a=this.childs;a.length&&a.forEach(function(a,b){a.index=b,a.row.setAttribute("childIndex",b)})},e.prototype.refreshPath=function(){this.path=[];for(var a=this;a;)a.parent&&this.path.unshift(a.parent),a=a.parent},e.prototype.getPath=function(){return this.refreshPath(),this.path},e.prototype._createDom=function(){var a=crel("a",{"class":"dot"},crel("span",{"class":"b"},crel("span",{"class":"s"}))),b=crel("div",{"class":"project-content",contentEditable:!0}),c=crel("div",{"class":"children"}),d=crel("div",{"class":"project",projectId:this.id},a,b,c);d.node=this,this.buttonElement=a,this.contentElement=b,this.childrenElement=c,this.row=d,this.setValue(),this._onDomReady()},e.prototype.refreshDom=function(){this.childs=[],this.childrenMap={},this._createDom()},e.prototype.adjustDom=function(a){function b(a){$(a).after(d.row)}function c(a){$(a).append(d.row)}var d=this;if(a)switch(a.type){case"after":b(a.el);break;case"append":c(a.el)}else this.parent.appendChild(this.row),z},e.prototype.onEvent=function(a){var b=a.type,c=a.target||a.srcElement;if("keydown"==b){var d=a.keyCode;if(13==d&&a.ctrlKey)return a.preventDefault(),this.createSiblingNodeAfter(),!1;if(13==d&&a.shiftKey)return a.preventDefault(),this._onInsertBefore({}),!1;if(9==a.keyCode)return a.preventDefault(),a.shiftKey?this.unindent():this.indent(),!1;if(46==a.keyCode)return a.preventDefault(),this.parent.removeChildAndDom(this),!1;8==a.keyCode&&""==this.getContent()&&this.parent.removeChildAndDom(this),"move"==this.app.mode}"click"==b&&((c==this.buttonElement||c==this.buttonElement.childNodes[0]||c==this.buttonElement.childNodes[0].childNodes[0])&&(a.altKey?this.collapse():this._onZoomIn()),c==this.contentElement&&this.app.setCurentNode(this)),("keyup"==b||"paste"==b||"cut"==b)&&this.onValueChange(),this.packageEventsHandle(a)},e.prototype.packageEventsHandle=function(a){var b=this;this.packageEvents&&this.packageEvents.length&&$.each(this.packageEvents,function(c,d){d.call(b,a)})},e.prototype.initPackages=function(){var a=this;this.packageEvents=this.packageEvents||[],this.packages=this.app.getPackages(),this.value.packageValue=this.value.packageValue||{},$.each(this.packages,function(b,c){$.extend(a,c.node),a.packageEvents.push(c.onEvent)})},e.prototype.onValueChange=function(){this.app.creating||(this.updateValue(),this.parent&&this.parent.onValueChange(),this.app.onAction("valueChange",{node:this}))},e.prototype.updateValue=function(){this.value=this.getValue()},e.prototype.getValue=function(){var a=this;return this.value.content=this.contentElement.innerHTML,this.value.packageValue=this.value.packageValue,this.value.children=[],this.hasChild()&&this.childs.forEach(function(b){a.value.children.push(b.getValue())}),this.value},e.prototype.formatValue=function(){return Array.isArray(this.value)?(this.value={content:"",children:this.value,packageValue:{}},this.value):(("string"==typeof this.value||this.value.constructor==String)&&(this.value={content:value,children:[],packageValue:{}}),this.value.content||(this.value.content=""),void(this.value.children||(this.value.children=[])))},e.prototype.setValue=function(a){a&&(this.value=a,this.formatValue()),this.value?(this.setContent(this.value.content),this.setChildren(this.value.children)):this.setValue("")},e.prototype.setContent=function(a){("string"==typeof this.value.content||this.value.content.constructor==String)&&(this.content=a,this.contentElement.innerHTML=this.content)},e.prototype.setParent=function(a){this.parent=a},e.prototype.setChildren=function(a){var b=this;Array.isArray(a)&&a.length>0&&(a.forEach(function(a,c){b._createChild(a)}),this.row.className+=" hasChild")},e.prototype.getContent=function(){return this.content=this.contentElement.innerHTML,this.content},e.prototype.setRoot=function(){this.row.classList.add("root"),this.isRootNode=!0},e.prototype.getRelativeNode=function(a){switch(a){case"before":var b=this.row.previousSibling;if(b){var c=b.getAttribute("projectId");return this.parent.findChildById(c)}return null;case"after":if(this.parent){var d=this.parent.childs[this.index+1];return d?d:null}return null}},e.prototype.addSiblingNodeBefore=function(a){this.isRootNode||(a.isRootNode&&(a.isRootNode=!1),a.parent&&a.parent.removeChild(a),a.setParent(this.parent),this.parent._addChild(a),$(this.row).before(a.row),this.onValueChange(this.parent))},e.prototype.addSiblingNodeAfter=function(a){var b=this.getRelativeNode("after");null!=b?b.addSiblingNodeBefore(a):this.parent.appendChild(a),this.onValueChange(this.parent)},e.prototype.addChildNodeAtHead=function(a){},e.prototype.addChildNodeAtTail=function(){},e.prototype.createSiblingNodeAfter=function(){var a=new e({},this.app);a.setParent(this.parent),a.adjustDom({type:"after",el:this.row}),this.parent._addChild(a),a.focus(a.contentElement),this.onValueChange(this.parent)},e.prototype._createChild=function(a){var b=new e(a,this.app);b.setParent(this),b.adjustDom({type:"append",el:this.childrenElement}),b.index=this.childs.length,this._addChild(b),b.focus(b.contentElement),this.onValueChange(this.parent)},e.prototype.appendChild=function(a){this.childrenElement.appendChild(a.row),this._addChild(a),a.index=this.childs.length,this.onValueChange(this.parent)},e.prototype._addChild=function(a){this.childs.push(a),this.childrenMap[a.id]=a,this.onValueChange(this.parent)},e.prototype.removeChild=function(a){this.childrenMap[a.id];this.childs=this.childs.filter(function(b){return b.id!=a.id}),this.childrenMap[a.id]=void 0,this._updateDomIndexes(),this.onValueChange(this.parent)},e.prototype.removeChildAndDom=function(a){var b=this.childrenMap[a.id];b.row.parentNode&&b.row.parentNode.removeChild(b.row),this.removeChild(a)},e.prototype.hasChild=function(){return this.childs.length},e.prototype._onInsertBefore=function(a){var b=new e(a,this.app);b.setParent(null),this.addSiblingNodeBefore(b),b.focus(b.contentElement),this.onValueChange(this.parent)},e.prototype._onInsertAfter=function(a){var b=new e(a,this.app);b.setParent(null),this.addSiblingNodeAfter(b),b.focus(b),this.app.onAction("insertAfter",{node:b,afterNode:this,parent:this.parent}),this.onValueChange(this.parent)},e.prototype._onIndent=function(){var a=this.getRelativeNode("before");a&&(a.appendChild(this),this.setParent(a)),this.onValueChange(this.parent)},e.prototype._onUnshift=function(a){var b=new e(a,this.app);b.setParent(this),this.onValueChange(this.parent)},e.prototype._onZoomIn=function(){this.app.onAction("zoomin",{node:this})},e.prototype._onDomReady=function(){},e.prototype.focus=function(a){var b=document.createRange(),c=window.getSelection();a.innerHTML.length?(b.setStart(a,1),b.setEnd(a,1)):(b.setStart(a,0),b.setEnd(a,0)),c.removeAllRanges(),c.addRange(b),a.focus()},e.prototype.blur=function(){this.contentElement.blur()},e.prototype.indent=function(){if(this.row.previousSibling){var a=this.getRelativeNode("before");this.parent.removeChildAndDom(this),a.appendChild(this),this.parent=a,this.focus(this.contentElement)}this.onValueChange(this.parent)},e.prototype.unindent=function(){this.parent&&(this.parent.addSiblingNodeAfter(this),this.onValueChange(this.parent))},e.prototype.getPrevNode=function(){if(this.prevNodeElement&&this.prevNode)return{el:this.prevNodeElement,node:this.prevNode};if(this.row.previousSibling){this.prevNodeElement=this.row.previousSibling;var a=this.prevNodeElement.getAttribute("projectId");return this.prevNode=this.parent.findChildById(a),this.getPrevNode()}return!1},e.prototype.collapseAnimating=!1,e.prototype.collapse=function(a){if(!this.collapseAnimating&&(this.collapseAnimating=!0,this.hasChild())){var b=this;$(this.childrenElement).hasClass("collapse")?($(b.row).removeClass("collapse"),$(this.childrenElement).animate({height:this.childrenHeight},200,function(){$(this).removeClass("collapse"),$(this).removeAttr("style"),b.collapseAnimating=!1})):(this.childrenHeight=$(this.childrenElement).height(),$(b.row).addClass("collapse"),$(this.childrenElement).animate({height:0},200,function(){$(this).addClass("collapse"),b.collapseAnimating=!1}))}},e.prototype.expand=function(){},e.prototype._destroy=function(){},e.prototype.findChildById=function(a){return this.childrenMap[a]},e.prototype.highlight=function(){this.highlighted=!0,this.contentElement.classList.add("highlight")},e.prototype.noHighlight=function(){this.highlighted=!1,this.contentElement.classList.remove("highlight")},e.prototype.move=function(a){a.preventDefault();var b=this.getRelativeNode("after");return b&&(this.noHighlight(),b.highlight(),this.app.setCurentNode(b)),!1},c.exports=e});